resources:
  containers:
  - container: envoy-container
    image: envoyproxy/envoy-build:cfc514546bc0284536893cca5fa43d7128edcd35
  - container: swiftlint-container
    image: norionomura/swiftlint:0.33.0_swift-5.0
  - container: jdk8
    image: openjdk:8-jdk

trigger:
- master

stages:
  - stage: android
    dependsOn: [] # this removes the implicit dependency on previous stage and causes this to run in parallel.
    jobs:
      - job: mac_kotlin_helloworld
        timeoutInMinutes: 60
        pool:
          vmImage: 'macos-10.14'
        steps:
          - checkout: self
            submodules: true
          - script: ./ci/mac_ci_setup.sh
            displayName: 'Install dependencies'
          - script: cd dist && tar -xvf envoy.tar.gz && cd ..
          - script: bazel build --fat_apk_cpu=x86 //examples/kotlin/hello_world:hello_envoy_kt
          - bash: |
              $ANDROID_HOME/tools/bin/sdkmanager --list
            displayName: "list already installed Android packages"
          - bash: |
              echo "y" | $ANDROID_HOME/tools/bin/sdkmanager --install 'system-images;android-28;google_apis;x86'
            displayName: 'install Android image'
          - script: |
              $ANDROID_HOME/emulator/emulator -list-avds
              echo '---'
              echo "no" | $ANDROID_HOME/tools/bin/avdmanager create avd -n test_android_emulator -k 'system-images;android-28;google_apis;x86' --force
              echo '---'
              $ANDROID_HOME/emulator/emulator -list-avds
            displayName: 'create AVD'
          - script: |
              $ANDROID_HOME/platform-tools/adb devices
              echo '---'
              nohup $ANDROID_HOME/emulator/emulator -avd test_android_emulator -no-snapshot > /dev/null 2>&1 & $ANDROID_HOME/platform-tools/adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed | tr -d '\r') ]]; do sleep 1; done; input keyevent 82'
              echo '---'
              $ANDROID_HOME/platform-tools/adb devices
            displayName: 'start Android emulator'
          - script: bazel mobile-install --fat_apk_cpu=x86 //examples/kotlin/hello_world:hello_envoy_kt
